<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Server Performance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      background: #0a0e1a; 
      color: #e6eef8; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .card { 
      background: linear-gradient(180deg, rgba(20,30,50,0.8), rgba(15,23,38,0.9)); 
      border-radius: 12px; 
      padding: 20px; 
      border: 1px solid rgba(100,130,180,0.15); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
    }
    .card:hover {
      border-color: rgba(100,130,180,0.25);
      transition: border-color 0.3s ease;
    }
    .small-muted { 
      color: #8b95a5; 
      font-size: 0.875rem; 
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .stat { 
      font-weight: 700; 
      font-size: 1.75rem; 
      line-height: 1.2;
      background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .success-chip { 
      background: rgba(16,185,129,0.15); 
      color: #10b981; 
      padding: 6px 12px; 
      border-radius: 8px; 
      font-weight: 600;
      font-size: 0.875rem;
      border: 1px solid rgba(16,185,129,0.3);
    }
    .danger-chip { 
      background: rgba(239,68,68,0.15); 
      color: #ef4444; 
      padding: 6px 12px; 
      border-radius: 8px; 
      font-weight: 600;
      font-size: 0.875rem;
      border: 1px solid rgba(239,68,68,0.3);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59,130,246,0.4);
    }
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239,68,68,0.4);
    }
    .btn-secondary {
      background: rgba(100,116,139,0.3);
      color: #e2e8f0;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid rgba(148,163,184,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      background: rgba(100,116,139,0.4);
      border-color: rgba(148,163,184,0.5);
    }
    .geo-bar {
      height: 20px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .geo-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    thead th {
      position: sticky;
      top: 0;
      background: rgba(15,23,38,0.95);
      backdrop-filter: blur(10px);
      padding: 10px 8px;
      text-align: left;
      border-bottom: 2px solid rgba(100,130,180,0.2);
      font-size: 0.8rem;
    }
    tbody tr {
      border-bottom: 1px solid rgba(100,130,180,0.08);
      transition: background 0.2s ease;
    }
    tbody tr:hover {
      background: rgba(59,130,246,0.05);
    }
    tbody td {
      padding: 10px 8px;
      font-size: 0.875rem;
    }
    .chart-container {
      position: relative;
      height: 180px;
      width: 100%;
    }
    .chart-container-sm {
      position: relative;
      height: 150px;
      width: 100%;
    }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto">

    <!-- HEADER -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold mb-1" style="background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          Server Performance Dashboard
        </h1>
        <p class="small-muted">Enterprise view â€” concurrency, latency, cache & sessions</p>
      </div>
      <div class="flex items-center space-x-3">
        <select id="load-type" class="bg-gray-800/50 text-white px-4 py-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none text-sm">
          <option value="continuous">Continuous</option>
          <option value="burst">Burst</option>
          <option value="spike">Spike</option>
          <option value="soak">Soak</option>
        </select>
        <button id="start-btn" class="btn-primary text-sm">Start Test</button>
        <button onclick="stopTest()" class="btn-danger text-sm">Stop Test</button>
        <button id="toggle-cache" class="btn-secondary text-sm">Toggle Cache</button>
      </div>
    </header>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-12 gap-4">
      
      <!-- LEFT COLUMN - Stats -->
      <div class="col-span-12 lg:col-span-8 space-y-4">
        
        <!-- Top Row - Key Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="card">
            <div class="small-muted mb-1">Active Clients</div>
            <div id="active-clients" class="stat">0</div>
          </div>
          <div class="card">
            <div class="small-muted mb-1">Total Requests</div>
            <div id="total-requests" class="stat">0</div>
          </div>
          <div class="card">
            <div class="small-muted mb-1">Avg Response</div>
            <div id="avg-response" class="stat text-xl">0 ms</div>
          </div>
          <div class="card">
            <div class="small-muted mb-1">Sessions</div>
            <div id="unique-sessions" class="stat">0</div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card">
            <div class="small-muted mb-2">Throughput</div>
            <div class="chart-container">
              <canvas id="throughputChart"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="small-muted mb-2">Latency Trend</div>
            <div class="chart-container">
              <canvas id="latencyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Status & Geo Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card">
            <div class="small-muted mb-2">HTTP Status Breakdown</div>
            <div class="chart-container-sm">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="small-muted mb-2">Geo Request Distribution</div>
            <div id="geo-chart" class="space-y-2 mt-3" style="max-height: 150px; overflow-y: auto;">
              <div class="small-muted text-center py-4">No geographic data yet</div>
            </div>
          </div>
        </div>

        <!-- Cache Info -->
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted mb-1">Cache Status</div>
              <div id="cache-status" class="success-chip">Enabled</div>
            </div>
            <div class="text-right">
              <div class="small-muted mb-1">Performance</div>
              <div class="flex items-center space-x-3">
                <div class="small-muted">Hits: <span id="cache-hits" class="text-green-400 font-semibold">0</span></div>
                <div class="small-muted">Misses: <span id="cache-misses" class="text-yellow-400 font-semibold">0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Session Table -->
        <div class="card">
          <div class="small-muted mb-3">Active User Sessions</div>
          <div class="overflow-auto" style="max-height: 280px;">
            <table>
              <thead>
                <tr class="small-muted">
                  <th>Session ID</th>
                  <th>Hits</th>
                  <th>Last Path</th>
                  <th>Device</th>
                </tr>
              </thead>
              <tbody id="session-table">
                <tr><td colspan="4" class="py-3 small-muted text-center">No session data yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN - Recent Activity -->
      <div class="col-span-12 lg:col-span-4 space-y-4">
        
        <!-- Thread Pool -->
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted mb-1">Thread Pool</div>
              <div id="thread-pool" class="stat">10</div>
            </div>
            <div class="text-right">
              <div class="small-muted mb-1">Queue</div>
              <div id="queue-size" class="stat">0</div>
            </div>
          </div>
        </div>

        <!-- Recent Requests -->
        <div class="card">
          <div class="small-muted mb-3">Recent Requests</div>
          <div class="overflow-auto" style="max-height: 600px;">
            <table>
              <thead>
                <tr class="small-muted">
                  <th>IP</th>
                  <th>Path</th>
                  <th class="text-right">Time</th>
                </tr>
              </thead>
              <tbody id="recent-requests">
                <tr><td colspan="3" class="py-3 small-muted text-center">No requests yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>

  </div>

<script>
// Country code to full name mapping
const countryNames = {
  'US': 'United States',
  'IN': 'India',
  'GB': 'United Kingdom',
  'DE': 'Germany',
  'FR': 'France',
  'AU': 'Australia',
  'BR': 'Brazil',
  'CA': 'Canada',
  'JP': 'Japan',
  'CN': 'China',
  'RU': 'Russia',
  'ES': 'Spain',
  'IT': 'Italy',
  'MX': 'Mexico',
  'KR': 'South Korea'
};

const maxPoints = 30;

// Throughput Chart
const throughputCtx = document.getElementById('throughputChart').getContext('2d');
const throughputData = { 
  labels: [], 
  datasets: [
    { 
      label: 'Active Clients', 
      data: [], 
      borderColor: '#10b981', 
      backgroundColor: 'rgba(16,185,129,0.1)', 
      fill: true, 
      tension: 0.4,
      borderWidth: 2,
      pointRadius: 0,
      pointHoverRadius: 3
    },
    { 
      label: 'Total Requests', 
      data: [], 
      borderColor: '#3b82f6', 
      backgroundColor: 'rgba(59,130,246,0.08)', 
      fill: true, 
      tension: 0.4, 
      yAxisID: 'y1',
      borderWidth: 2,
      pointRadius: 0,
      pointHoverRadius: 3
    }
  ]
};

const throughputChart = new Chart(throughputCtx, {
  type: 'line', 
  data: throughputData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: {
        display: true,
        position: 'top',
        labels: { color: '#9aa6b2', font: { size: 10 }, boxWidth: 12, boxHeight: 12 }
      }
    },
    scales: {
      x: { 
        display: false
      },
      y: { 
        position: 'left', 
        ticks: { color: '#10b981', font: { size: 9 } },
        grid: { color: 'rgba(100,130,180,0.08)' }
      },
      y1: { 
        position: 'right', 
        ticks: { color: '#3b82f6', font: { size: 9 } }, 
        grid: { display: false } 
      }
    }
  }
});

// Latency Chart
const latencyCtx = document.getElementById('latencyChart').getContext('2d');
const latencyData = { 
  labels: [], 
  datasets: [{
    label: 'Latency (ms)', 
    data: [], 
    borderColor: '#f97316', 
    backgroundColor: 'rgba(249,115,22,0.1)', 
    fill: true, 
    tension: 0.4,
    borderWidth: 2,
    pointRadius: 0,
    pointHoverRadius: 3
  }]
};

const latencyChart = new Chart(latencyCtx, { 
  type: 'line', 
  data: latencyData, 
  options: { 
    responsive: true, 
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false }
    },
    scales: { 
      x: { display: false },
      y: { 
        ticks: { color: '#f97316', font: { size: 9 } },
        grid: { color: 'rgba(100,130,180,0.08)' }
      } 
    } 
  } 
});

function pushThroughputPoint(label, active, total) {
  throughputData.labels.push(label);
  throughputData.datasets[0].data.push(active);
  throughputData.datasets[1].data.push(total);
  if (throughputData.labels.length > maxPoints) {
    throughputData.labels.shift();
    throughputData.datasets.forEach(ds => ds.data.shift());
  }
  throughputChart.update('none');
}

function pushLatencyPoint(label, val) {
  latencyData.labels.push(label);
  latencyData.datasets[0].data.push(val);
  if (latencyData.labels.length > maxPoints) {
    latencyData.labels.shift();
    latencyData.datasets.forEach(ds => ds.data.shift());
  }
  latencyChart.update('none');
}

// Status Chart
const statusCtx = document.getElementById("statusChart").getContext("2d");
const statusChart = new Chart(statusCtx, {
  type: "doughnut",
  data: {
    labels: ["200 OK", "400 Errors", "404 Not Found", "500 Server Errors"],
    datasets: [{
      data: [0, 0, 0, 0],
      backgroundColor: ["#10b981", "#facc15", "#3b82f6", "#ef4444"],
      borderWidth: 0
    }]
  }, 
  options: { 
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: { 
          color: '#9aa6b2',
          font: { size: 9 },
          padding: 8,
          boxWidth: 10,
          boxHeight: 10
        }
      }
    }
  }
});

async function fetchMetrics() {
  try {
    const res = await fetch('/metrics');
    const data = await res.json();

    document.getElementById('active-clients').textContent = data.active_clients ?? 0;
    document.getElementById('total-requests').textContent = data.total_requests ?? 0;
    document.getElementById('avg-response').textContent = ((data.average_response_time ?? 0) * 1000).toFixed(2) + ' ms';
    document.getElementById('unique-sessions').textContent = data.unique_sessions ?? 0;
    document.getElementById('cache-hits').textContent = data.cache_hits ?? 0;
    document.getElementById('cache-misses').textContent = data.cache_misses ?? 0;
    document.getElementById('thread-pool').textContent = data.thread_pool_size ?? '-';
    document.getElementById('queue-size').textContent = data.queue_size ?? 0;

    const nowLabel = new Date().toLocaleTimeString();
    pushThroughputPoint(nowLabel, data.active_clients ?? 0, data.total_requests ?? 0);

    if (data.latency_trend?.length) {
      pushLatencyPoint(nowLabel, data.latency_trend.slice(-1)[0]);
    }

    // Update status codes
    const s = data.status_codes || {};
    const values = [
      parseInt(s["200"]) || 0,
      parseInt(s["400"]) || 0,
      parseInt(s["404"]) || 0,
      parseInt(s["500"]) || 0
    ];
    statusChart.data.datasets[0].data = values;
    statusChart.update('none');

    // Update cache status
    if (data.cache_enabled) {
      document.getElementById('cache-status').className = 'success-chip';
      document.getElementById('cache-status').textContent = 'Enabled';
    } else {
      document.getElementById('cache-status').className = 'danger-chip';
      document.getElementById('cache-status').textContent = 'Disabled';
    }

    // Update geo distribution with full country names
    const geoChart = document.getElementById('geo-chart');
    if (data.geo && Object.keys(data.geo).length > 0) {
      const geoEntries = Object.entries(data.geo).sort((a, b) => b[1] - a[1]);
      const maxGeo = Math.max(...geoEntries.map(e => e[1]));
      geoChart.innerHTML = geoEntries.map(([code, count]) => {
        const percentage = maxGeo > 0 ? (count / maxGeo * 100) : 0;
        const countryName = countryNames[code] || code;
        return `
          <div class="flex items-center gap-2">
            <div class="small-muted w-28 text-xs">${countryName}</div>
            <div class="flex-1">
              <div class="geo-bar" style="width: ${percentage}%"></div>
            </div>
            <div class="small-muted w-12 text-right font-semibold">${count}</div>
          </div>
        `;
      }).join('');
    } else {
      geoChart.innerHTML = '<div class="small-muted text-center py-4">No geographic data yet</div>';
    }

    // Update session table
    const sBody = document.getElementById("session-table");
    if (data.session_summary?.length) {
      sBody.innerHTML = data.session_summary.map(it => `
        <tr>
          <td class="small-muted font-mono" style="font-size: 0.75rem;">${it.session_id.substring(0, 8)}...</td>
          <td class="text-green-400 font-semibold">${it.hit_count}</td>
          <td class="small-muted">${it.last_path || "-"}</td>
          <td>
            <span class="px-2 py-1 rounded text-xs" style="background: rgba(59,130,246,0.15); color: #3b82f6;">
              ${it.device_type || "unknown"}
            </span>
          </td>
        </tr>
      `).join("");
    } else {
      sBody.innerHTML = '<tr><td colspan="4" class="py-3 small-muted text-center">No session data yet</td></tr>';
    }

    // Update recent requests
    const tbody = document.getElementById('recent-requests');
    if (data.recent_requests?.length) {
      tbody.innerHTML = data.recent_requests.map(r => `
        <tr>
          <td class="small-muted font-mono" style="font-size: 0.75rem;">${r.ip}</td>
          <td class="small-muted" style="font-size: 0.8rem;">${r.path}</td>
          <td class="text-right">
            <span class="text-orange-400 font-semibold" style="font-size: 0.8rem;">${((r.response_time||0)*1000).toFixed(1)}</span>
            <span class="small-muted" style="font-size: 0.7rem;">ms</span>
          </td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="3" class="py-3 small-muted text-center">No requests yet</td></tr>';
    }

  } catch(e) {
    console.error('Fetch error:', e);
  }
}

setInterval(fetchMetrics, 1000);
fetchMetrics();

document.getElementById('start-btn').addEventListener('click', async () => {
    const mode = document.getElementById("load-type")?.value || "continuous";

    const payload = {
        mode: mode,
        clients: 100,
        path: "/index.html",
        rounds: 1,
        stagger_ms: 5
    };

    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
        const res = await fetch('/start_test', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        btn.textContent = 'Running...';
        setTimeout(() => { btn.textContent = 'Start Test'; btn.disabled = false; }, 3000);
    } catch (err) {
        console.error("Start test failed:", err);
        btn.textContent = 'Start Test'; 
        btn.disabled = false;
    }
});

async function stopTest() {
  try {
    await fetch("/stop_test", { method: "POST" });
    const btn = document.getElementById('start-btn');
    btn.textContent = 'Start Test';
    btn.disabled = false;
  } catch(e) {
    console.error("Stop error", e);
  }
}

document.getElementById('toggle-cache').addEventListener('click', async () => {
  try {
    const res = await fetch('/toggle_cache');
    const j = await res.json();
    const statusEl = document.getElementById('cache-status');
    if (j.cache_enabled) {
      statusEl.className = 'success-chip';
      statusEl.textContent = 'Enabled';
    } else {
      statusEl.className = 'danger-chip';
      statusEl.textContent = 'Disabled';
    }
  } catch(e) { 
    console.error(e); 
  }
});
</script>

</body>
</html>
